/*! lungo-angular-bridge - v0.1.3 - 2013-05-31 */
angular.module("Centralway.lungo-angular-bridge",[]).value("labOptions",{});var AppRouter=function(n,t,e){var o=[];t.replace;var i=2,a=1,r=2;t.replace=function(){return t.$$replace=!0,t};var l=function(n){var t=angular.isArray(n)?n:n.split("/");return t.length>i},u=function(t){if(-1===t.indexOf("#")&&(t="#"+t),0===n.dom(t).length)throw Error("No such element with ID ["+t+"]")},c=function(t){var e=t.split("/"),o=""!==e[a]?e[a]:"main";u(o),e.length>i?(u(e[r]),n.Router.article(o,e[r])):n.Router.section(o)},d=function(n){if(0===o.length)return!1;var t=o[o.length-1].split("/"),e=n.split("/");return t[a]===e[a]},s=function(){var t=n.dom('aside[class*="show"]');angular.forEach(t,function(t){n.View.Aside.toggle("#"+n.dom(t).attr("id"))}),n.dom('section[class*="aside"]').removeClass("aside")},p=function(n){return d(n.path())?o.length>0&&o[o.length-2]===n.path()&&!l(n.path()):o.length>0&&o[o.length-2]===n.path()},g=function(){return p(t)};e.$on("$routeChangeSuccess",function(){if(s(),p(t)){o.pop();try{n.Router.back()}catch(e){throw console.log("AppRouter::$routeChangeSuccess - caught exception while navigating back to ",t.path()," : ",e),e}}else c(t.path()),d(t.path())||o.push(t.path())});var v=function(){if(2>o.length)throw Error("No back to go back to!");return o[o.length-2]},f=function(){if(0!==o.length){var n=v();t.path(n)}};return{back:f,isBack:g,isSameSection:d}};angular.module("Centralway.lungo-angular-bridge").directive("labAside",["labOptions",function(n){var t=function(n){var t={SHOW:Lungo.Constants.CLASS.SHOW},e=Lungo.View.Aside.show,o=Lungo.View.Aside.hide,i=parseInt(document.body.getBoundingClientRect().width/3,10);n.each(function(){var n=!1,a=Lungo.dom(this),r=a.closest("section"),l=Lungo.dom("#"+a.attr("lab-aside"));r.swiping(function(e){if(!r.hasClass("aside")){var o=e.currentTouch.x-e.iniTouch.x,i=Math.abs(e.currentTouch.y-e.iniTouch.y);n=n?!0:o>3*i&&50>o,n?(o=o>256?256:0>o?0:o,l.addClass(t.SHOW),r.vendor("transform","translateX("+o+"px)"),r.vendor("transition-duration","0s")):r.attr("style","")}}),r.swipe(function(t){var a=t.currentTouch.x-t.iniTouch.x;Math.abs(t.currentTouch.y-t.iniTouch.y),r.attr("style",""),a>i&&n?e(l):o(l),n=!1})})};return{restrict:"A",link:function(e,o,i){var a={};a.swipeEnabled=i.noSwipe?!1:n.doAsideSwipe;var r=o.attr("lab-aside"),l="tap";Lungo.dom(o[0]).bind(l,function(n){Lungo.View.Aside.toggle("#"+r),n.preventDefault()}),a.swipeEnabled&&t(Lungo.dom(o[0]))}}}]),angular.module("Centralway.lungo-angular-bridge").directive("labBoot",["$location",function(n){function t(n){return-1===n.indexOf(",")?n:n.split(",")}function e(n,t,e){return n[t]?0===n[t].length?!0:"true"===n[t].toLowerCase():e}return function(o,i,a){Lungo.init({resources:i.attr("resources")&&t(i.attr("resources"))});var r={doAsideSwipe:e(a,"asideSwiping",!0)};angular.module("Centralway.lungo-angular-bridge").value("labOptions",r),AppRouter.instance=AppRouter(Lungo,n,o)}}]),function(n,t){var e="swipe swiping swipeLeft swipeRight swipeDown swipeUp tap hold singleTap doubleTap pinch pinching pinchIn pinchOut rotate rotating rotateLeft rotateRight";angular.forEach(e.split(" "),function(e){var o=e.charAt(0).toUpperCase()+e.slice(1),i="lab"+o;n.directive(i,["$parse",function(n){return{restrict:"A",link:function(o,a,r){var l=n(r[i]);t.dom(a[0]).on(e,function(n){n.preventDefault(),o.$apply(function(){l(o,{$event:n})})})}}}])}),n.directive("href",["$location",function(){return{restrict:"A",link:function(n,e,o){if("A"===e[0].tagName.toUpperCase()){if(void 0!==o.noHref)return console.log("directive:href - explicit unbind, not handling taps"),void 0;o.href,t.dom(e[0]).on("tap",function(){t.dom(e[0]).trigger("click")})}}}}])}(angular.module("Centralway.lungo-angular-bridge"),Lungo),angular.module("Centralway.lungo-angular-bridge").directive("labPopup",["popupService",function(n){return{restrict:"A",link:function(t,e,o){var i=o.labPopup,a={};o.controller&&(a.controller=o.controller),e.bind("click",function(){n.load(i,t,a)})}}}]),angular.module("Centralway.lungo-angular-bridge").directive("labView",["$http","$templateCache","$route","$anchorScroll","$compile","$controller","$location","$log",function(n,t,e,o,i,a,r,l){var u=function(n){var t=void 0===n,e=t?Lungo.dom('*[class*="lab-view"]'):Lungo.dom(n[0]);return 0===e.length?(l.error("labView::initialiseLoadedContent() - could not find class with lab-view to do a Lungo boot on"),void 0):(e.hasClass("lab-inited-view")?l.warn("labView::initialiseLoadedContent() - lab-view-inited element already exists"):(l.info("labView::viewContentLoaded - booting content"),Lungo.Boot.Data.init("#"+e.attr("id")),e.addClass("lab-inited-view")),void 0)};return{restrict:"ECA",terminal:!0,link:function(n,t,l){function c(){g&&(g.$destroy(),g=null)}function d(){return Lungo.dom('*[class*="lab-view"]')}function s(n){var t=Lungo.dom('*[class*="lab-old-view"]');t.length>0&&t.remove(),n.removeClass("lab-view").addClass("lab-old-view"),n.length>0&&n.attr("lab-view-old-id",n.attr("id")).removeAttr("id")}function p(){var l=e.current&&e.current.locals,p=l&&l.$template;if(p&&!AppRouter.instance.isSameSection(r.path())){n.$emit("$labViewUpdateStart",null);var f=t.parent(),h=d();s(h);var w=null;if(f.append(p),w=angular.element(f.children()[f.children().length-1]),w.addClass("lab-view"),!w.attr("id"))throw Error("Elements loaded via templates must have an ID attribute");if(AppRouter.instance.isBack(r)){var m=h.data("transition");w.attr("data-transition-origin",m),w.addClass("hide")}u(w),c();var b,$=i(w.contents()),C=e.current;g=C.scope=n.$new(),C.controller&&(l.$scope=g,b=a(C.controller,l),w.contents().data("$ngControllerController",b)),$(g),g.$emit("$viewContentLoaded"),g.$eval(v),o(),n.$emit("labViewUpdateFinished",null)}}var g,v=l.onload||"";n.$on("$routeChangeSuccess",p),p()}}}]),angular.module("Centralway.lungo-angular-bridge").directive("labWindow",["popupService",function(n){return{restrict:"A",link:function(t,e,o){var i=o.labWindow,a={};o.transition&&(a.transition=o.transition),o.controller&&(a.controller=o.controller),e.bind("click",function(){n.showWindow(i,t,a)})}}}]),function(n,t,e){t.service("labRouterService",[function(){return{back:function(){e.instance.back()},isBack:function(){return e.instance.isBack()},isSameSection:function(n){return e.instance.isSameSection(n)}}}])}(Lungo,angular.module("Centralway.lungo-angular-bridge"),AppRouter),angular.module("Centralway.lungo-angular-bridge").factory("popupService",["$http","$compile","$timeout",function(n,t,e){var o={};return o.getPopup=function(n){return!o.popupElement&&n&&(o.popupElement=$$('<div class="notification"><div class="window show"></div></div>'),$$(window.document.body).append(o.popupElement)),o.popupElement},o.compileAndRunPopup=function(n,e){var o=angular.element(n[0]);t(o)(e),n.show()},o.load=function(t,e,i){var a="<div ng-include=\"'"+t+"'\"></div>";n.get(void 0).success(function(){var n=o.getPopup(!0),t=n;t.find("div").html(a),o.compileAndRunPopup(t,e,i)})},o.getWindow=function(n){if(!o.windowElement&&n){var t=Math.floor(1e6*Math.random()),e=t+(new Date).getTime(),i=$$('<section id="section_'+e+'" ng-include=""></section>');$$(window.document.body).append(i),o.windowElement=i}return o.windowElement},o.showWindow=function(n,i,a){var r=a.transition||"",l=o.getWindow(!0);l.attr("ng-include","'"+n+"'"),l.attr("data-transition",r),a.controller&&l.attr("ng-controller",a.controller);var u=angular.element(l[0]);t(u)(i),i.$on("$includeContentLoaded",function(){Lungo.Boot.Data.init("#"+l.attr("id"))}),e(function(){Lungo.Router.section(l.attr("id"))},1)},o.close=function(){var n=o.getPopup(),t=o.getWindow();n&&(n.hide(),n.remove(),delete o.popupElement),t&&(Lungo.Router.back(),e(function(){t.remove(),delete o.windowElement},400))},o}]);